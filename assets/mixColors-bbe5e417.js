import{E as V,u as b,B as R}from"./index-5f17f4b1.js";class H{constructor(t){this.resources=Object.create(null),this._dirty=!0;let e=0;for(const s in t){const n=t[s];this.setResource(n,e++)}this._updateKey()}_updateKey(){if(!this._dirty)return;this._dirty=!1;const t=[];let e=0;for(const s in this.resources)t[e++]=this.resources[s]._resourceId;this._key=t.join("|")}setResource(t,e){var n,r;const s=this.resources[e];t!==s&&(s&&((n=t.off)==null||n.call(t,"change",this.onResourceChange,this)),(r=t.on)==null||r.call(t,"change",this.onResourceChange,this),this.resources[e]=t,this._dirty=!0)}getResource(t){return this.resources[t]}_touch(t){const e=this.resources;for(const s in e)e[s]._touched=t}destroy(){var e;const t=this.resources;for(const s in t){const n=t[s];(e=n.off)==null||e.call(n,"change",this.onResourceChange,this)}this.resources=null}onResourceChange(){this._dirty=!0,this._updateKey()}}var o=(i=>(i[i.MAP_READ=1]="MAP_READ",i[i.MAP_WRITE=2]="MAP_WRITE",i[i.COPY_SRC=4]="COPY_SRC",i[i.COPY_DST=8]="COPY_DST",i[i.INDEX=16]="INDEX",i[i.VERTEX=32]="VERTEX",i[i.UNIFORM=64]="UNIFORM",i[i.STORAGE=128]="STORAGE",i[i.INDIRECT=256]="INDIRECT",i[i.QUERY_RESOLVE=512]="QUERY_RESOLVE",i[i.STATIC=1024]="STATIC",i))(o||{});class A extends V{constructor(t){let{data:e,size:s}=t;const{usage:n,label:r,shrinkToFit:h}=t;super(),this.uid=b("buffer"),this._resourceType="buffer",this._resourceId=b("resource"),this._touched=0,this._updateID=1,this.shrinkToFit=!0,e instanceof Array&&(e=new Float32Array(e)),this._data=e,s=s??(e==null?void 0:e.byteLength);const u=!!e;this.descriptor={size:s,usage:n,mappedAtCreation:u,label:r},this.shrinkToFit=h??!0}get data(){return this._data}set data(t){this.setDataWithSize(t,t.length,!0)}get static(){return!!(this.descriptor.usage&o.STATIC)}set static(t){t?this.descriptor.usage|=o.STATIC:this.descriptor.usage&=~o.STATIC}setDataWithSize(t,e,s){if(this._updateID++,this._updateSize=e*t.BYTES_PER_ELEMENT,this._data===t){s&&this.emit("update",this);return}const n=this._data;if(this._data=t,n.length!==t.length){!this.shrinkToFit&&t.byteLength<n.byteLength?s&&this.emit("update",this):(this.descriptor.size=t.byteLength,this._resourceId=b("resource"),this.emit("change",this));return}s&&this.emit("update",this)}update(t){this._updateSize=t??this._updateSize,this._updateID++,this.emit("update",this)}destroy(){this.emit("destroy",this),this._data=null,this.descriptor=null,this.removeAllListeners()}}function g(i,t){if(!(i instanceof A)){let e=t?o.INDEX:o.VERTEX;i instanceof Array&&(t?(i=new Uint32Array(i),e=o.INDEX|o.COPY_DST):(i=new Float32Array(i),e=o.VERTEX|o.COPY_DST)),i=new A({data:i,label:t?"index-mesh-buffer":"vertex-mesh-buffer",usage:e})}return i}function P(i,t,e){const s=i.getAttribute(t);if(!s)return e.minX=0,e.minY=0,e.maxX=0,e.maxY=0,e;const n=s.buffer.data;let r=1/0,h=1/0,u=-1/0,_=-1/0;const c=n.BYTES_PER_ELEMENT,f=(s.offset||0)/c,x=(s.stride||2*4)/c;for(let d=f;d<n.length;d+=x){const l=n[d],a=n[d+1];l>u&&(u=l),a>_&&(_=a),l<r&&(r=l),a<h&&(h=a)}return e.minX=r,e.minY=h,e.maxX=u,e.maxY=_,e}function M(i){return(i instanceof A||Array.isArray(i)||i.BYTES_PER_ELEMENT)&&(i={buffer:i}),i.buffer=g(i.buffer,!1),i}class Y extends V{constructor(t){const{attributes:e,indexBuffer:s,topology:n}=t;super(),this.uid=b("geometry"),this._layoutKey=0,this.instanceCount=1,this._bounds=new R,this._boundsDirty=!0,this.attributes=e,this.buffers=[],this.instanceCount=t.instanceCount||1;for(const r in e){const h=e[r]=M(e[r]);this.buffers.indexOf(h.buffer)===-1&&(this.buffers.push(h.buffer),h.buffer.on("update",this.onBufferUpdate,this),h.buffer.on("change",this.onBufferUpdate,this))}s&&(this.indexBuffer=g(s,!0),this.buffers.push(this.indexBuffer)),this.topology=n||"triangle-list"}onBufferUpdate(){this._boundsDirty=!0,this.emit("update",this)}getAttribute(t){return this.attributes[t]}getIndex(){return this.indexBuffer}getBuffer(t){return this.getAttribute(t).buffer}getSize(){for(const t in this.attributes){const e=this.attributes[t];return e.buffer.data.length/(e.stride/4||e.size)}return 0}get bounds(){return this._boundsDirty?(this._boundsDirty=!1,P(this,"aPosition",this._bounds)):this._bounds}destroy(t=!1){this.emit("destroy",this),this.removeAllListeners(),t&&this.buffers.forEach(e=>e.destroy()),this.attributes=null,this.buffers=null,this.indexBuffer=null,this._bounds=null}}const C=new Float32Array(1),N=new Uint32Array(1);class W extends Y{constructor(){const e=new A({data:C,label:"attribute-batch-buffer",usage:o.VERTEX|o.COPY_DST,shrinkToFit:!1}),s=new A({data:N,label:"index-batch-buffer",usage:o.INDEX|o.COPY_DST,shrinkToFit:!1}),n=6*4;super({attributes:{aPosition:{buffer:e,format:"float32x2",stride:n,offset:0,location:1},aUV:{buffer:e,format:"float32x2",stride:n,offset:2*4,location:3},aColor:{buffer:e,format:"unorm8x4",stride:n,offset:4*4,location:0},aTextureIdAndRound:{buffer:e,format:"uint16x2",stride:n,offset:5*4,location:2}},indexBuffer:s})}}const k=16;class m{constructor(t){typeof t=="number"?this.rawBinaryData=new ArrayBuffer(t):t instanceof Uint8Array?this.rawBinaryData=t.buffer:this.rawBinaryData=t,this.uint32View=new Uint32Array(this.rawBinaryData),this.float32View=new Float32Array(this.rawBinaryData),this.size=this.rawBinaryData.byteLength}get int8View(){return this._int8View||(this._int8View=new Int8Array(this.rawBinaryData)),this._int8View}get uint8View(){return this._uint8View||(this._uint8View=new Uint8Array(this.rawBinaryData)),this._uint8View}get int16View(){return this._int16View||(this._int16View=new Int16Array(this.rawBinaryData)),this._int16View}get int32View(){return this._int32View||(this._int32View=new Int32Array(this.rawBinaryData)),this._int32View}get float64View(){return this._float64Array||(this._float64Array=new Float64Array(this.rawBinaryData)),this._float64Array}get bigUint64View(){return this._bigUint64Array||(this._bigUint64Array=new BigUint64Array(this.rawBinaryData)),this._bigUint64Array}view(t){return this[`${t}View`]}destroy(){this.rawBinaryData=null,this._int8View=null,this._uint8View=null,this._int16View=null,this.uint16View=null,this._int32View=null,this.uint32View=null,this.float32View=null}static sizeOf(t){switch(t){case"int8":case"uint8":return 1;case"int16":case"uint16":return 2;case"int32":case"uint32":case"float32":return 4;default:throw new Error(`${t} isn't a valid view type`)}}}function E(i,t){const e=i.byteLength/8|0,s=new Float64Array(i,0,e);new Float64Array(t,0,e).set(s);const r=i.byteLength-e*8;if(r>0){const h=new Uint8Array(i,e*8,r);new Uint8Array(t,e*8,r).set(h)}}const F={normal:"normal-npm",add:"add-npm",screen:"screen-npm"};var X=(i=>(i[i.DISABLED=0]="DISABLED",i[i.RENDERING_MASK_ADD=1]="RENDERING_MASK_ADD",i[i.MASK_ACTIVE=2]="MASK_ACTIVE",i[i.RENDERING_MASK_REMOVE=3]="RENDERING_MASK_REMOVE",i[i.NONE=4]="NONE",i))(X||{});function S(i,t){return t.alphaMode==="no-premultiply-alpha"&&F[i]||i}class p{constructor(){this.ids=Object.create(null),this.textures=[],this.count=0}clear(){for(let t=0;t<this.count;t++){const e=this.textures[t];this.textures[t]=null,this.ids[e.uid]=null}this.count=0}}class z{constructor(){this.renderPipeId="batch",this.action="startBatch",this.start=0,this.size=0,this.blendMode="normal",this.canBundle=!0}destroy(){this.textures=null,this.gpuBindGroup=null,this.bindGroup=null,this.batcher=null}}let w=0;const T=class D{constructor(t={}){this.uid=b("batcher"),this.dirty=!0,this.batchIndex=0,this.batches=[],this._vertexSize=6,this._elements=[],this._batchPool=[],this._batchPoolIndex=0,this._textureBatchPool=[],this._textureBatchPoolIndex=0,t={...D.defaultOptions,...t};const{vertexSize:e,indexSize:s}=t;this.attributeBuffer=new m(e*this._vertexSize*4),this.indexBuffer=new Uint16Array(s)}begin(){this.batchIndex=0,this.elementSize=0,this.elementStart=0,this.indexSize=0,this.attributeSize=0,this._batchPoolIndex=0,this._textureBatchPoolIndex=0,this._batchIndexStart=0,this._batchIndexSize=0,this.dirty=!0}add(t){this._elements[this.elementSize++]=t,t.indexStart=this.indexSize,t.location=this.attributeSize,t.batcher=this,this.indexSize+=t.indexSize,this.attributeSize+=t.vertexSize*this._vertexSize}checkAndUpdateTexture(t,e){const s=t.batch.textures.ids[e._source.uid];return!s&&s!==0?!1:(t.textureId=s,t.texture=e,!0)}updateElement(t){this.dirty=!0,t.packAttributes(this.attributeBuffer.float32View,this.attributeBuffer.uint32View,t.location,t.textureId)}break(t){const e=this._elements;let s=this._textureBatchPool[this._textureBatchPoolIndex++]||new p;if(s.clear(),!e[this.elementStart])return;const n=e[this.elementStart];let r=S(n.blendMode,n.texture._source);this.attributeSize*4>this.attributeBuffer.size&&this._resizeAttributeBuffer(this.attributeSize*4),this.indexSize>this.indexBuffer.length&&this._resizeIndexBuffer(this.indexSize);const h=this.attributeBuffer.float32View,u=this.attributeBuffer.uint32View,_=this.indexBuffer;let c=this._batchIndexSize,f=this._batchIndexStart,x="startBatch",d=this._batchPool[this._batchPoolIndex++]||new z;for(let l=this.elementStart;l<this.elementSize;++l){const a=e[l];e[l]=null;const y=a.texture._source,B=S(a.blendMode,y),I=r!==B;if(y._batchTick===w&&!I){a.textureId=y._textureBindLocation,c+=a.indexSize,a.packAttributes(h,u,a.location,a.textureId),a.packIndex(_,a.indexStart,a.location/this._vertexSize),a.batch=d;continue}y._batchTick=w,(s.count>=k||I)&&(this._finishBatch(d,f,c-f,s,r,t,x),x="renderBatch",f=c,r=B,s=this._textureBatchPool[this._textureBatchPoolIndex++]||new p,s.clear(),d=this._batchPool[this._batchPoolIndex++]||new z,++w),a.textureId=y._textureBindLocation=s.count,s.ids[y.uid]=s.count,s.textures[s.count++]=y,a.batch=d,c+=a.indexSize,a.packAttributes(h,u,a.location,a.textureId),a.packIndex(_,a.indexStart,a.location/this._vertexSize)}s.count>0&&(this._finishBatch(d,f,c-f,s,r,t,x),f=c,++w),this.elementStart=this.elementSize,this._batchIndexStart=f,this._batchIndexSize=c}_finishBatch(t,e,s,n,r,h,u){t.gpuBindGroup=null,t.action=u,t.batcher=this,t.textures=n,t.blendMode=r,t.start=e,t.size=s,++w,h.add(t)}finish(t){this.break(t)}ensureAttributeBuffer(t){t*4<=this.attributeBuffer.size||this._resizeAttributeBuffer(t*4)}ensureIndexBuffer(t){t<=this.indexBuffer.length||this._resizeIndexBuffer(t)}_resizeAttributeBuffer(t){const e=Math.max(t,this.attributeBuffer.size*2),s=new m(e);E(this.attributeBuffer.rawBinaryData,s.rawBinaryData),this.attributeBuffer=s}_resizeIndexBuffer(t){const e=this.indexBuffer;let s=Math.max(t,e.length*1.5);s+=s%2;const n=s>65535?new Uint32Array(s):new Uint16Array(s);if(n.BYTES_PER_ELEMENT!==e.BYTES_PER_ELEMENT)for(let r=0;r<e.length;r++)n[r]=e[r];else E(e.buffer,n.buffer);this.indexBuffer=n}destroy(){for(let t=0;t<this.batches.length;t++)this.batches[t].destroy();this.batches=null;for(let t=0;t<this._elements.length;t++)this._elements[t].batch=null;this._elements=null,this.indexBuffer=null,this.attributeBuffer.destroy(),this.attributeBuffer=null}};T.defaultOptions={vertexSize:4,indexSize:6};let U=T;function v(i,t,e){const s=i>>16&255,n=i>>8&255,r=i&255,h=t>>16&255,u=t>>8&255,_=t&255,c=s+(h-s)*e,f=n+(u-n)*e,x=r+(_-r)*e;return(c<<16)+(f<<8)+x}const L=16777215+16777215;function O(i,t){return i+(t<<32)!==L?i===16777215?t:t===16777215?i:v(i,t,.5):16777215}export{H as B,Y as G,k as M,X as S,o as a,A as b,U as c,W as d,E as f,O as m};
